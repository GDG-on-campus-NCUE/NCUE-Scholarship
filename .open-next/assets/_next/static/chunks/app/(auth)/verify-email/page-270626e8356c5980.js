(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5071],{1243:(e,t,s)=>{"use strict";s.d(t,{A:()=>r});let r=(0,s(19946).A)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},25215:(e,t,s)=>{"use strict";s.d(t,{A:()=>r});let r=s(51030).A},33962:(e,t,s)=>{Promise.resolve().then(s.bind(s,88479))},40646:(e,t,s)=>{"use strict";s.d(t,{A:()=>r});let r=(0,s(19946).A)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},45749:(e,t,s)=>{"use strict";s.d(t,{N:()=>n});var r=s(55647);let a="https://scholarship-api.ncuesa.org.tw",l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNzU0NDA5NjAwLCJleHAiOjE5MTIxNzYwMDB9.jqoKh3OJbr8hsKd1CTuz6UcEPGuzO_gZEL9HT67q_GY";if(!a||!l)throw console.error("Supabase configuration:",{url:a,hasAnonKey:!!l}),Error("Missing Supabase environment variables. Please check your .env.local file.");console.log("[SUPABASE-CLIENT] Configured with URL:",a);let n=(0,r.UU)(a,l)},51030:(e,t,s)=>{"use strict";s.d(t,{O:()=>u,A:()=>c});var r=s(95155),a=s(12115),l=s(45749);let n={async signUp(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{let{data:r,error:a}=await l.N.auth.signUp({email:e,password:t,options:{data:{name:s.name,student_id:s.student_id,department:s.department,year:s.year},emailRedirectTo:"".concat(window.location.origin,"/auth/callback")}});if(a)throw a;return{success:!0,data:r}}catch(e){return console.error("Sign-up failed:",e),{success:!1,error:e.message}}},async signIn(e,t){try{let{data:s,error:r}=await l.N.auth.signInWithPassword({email:e,password:t});if(r)throw r;return{success:!0,data:s}}catch(e){return{success:!1,error:e.message}}},async signOut(){try{let{error:e}=await l.N.auth.signOut();if(e)throw e;return{success:!0}}catch(e){return{success:!1,error:e.message}}},async getCurrentUser(){try{let{data:{user:e},error:t}=await l.N.auth.getUser();if(t)throw t;if(e){let{data:t,error:s}=await l.N.from("profiles").select("*").eq("id",e.id).single();return s&&"PGRST116"!==s.code&&console.error("Error fetching profile:",s),{success:!0,user:{...e,profile:t||null,role:(null==t?void 0:t.role)||"user"}}}return{success:!0,user:null}}catch(e){return{success:!1,error:e.message}}},async getUserProfile(e){try{let{data:t,error:s}=await l.N.from("profiles").select("*").eq("id",e).single();if(s)throw s;return{success:!0,data:t}}catch(e){return{success:!1,error:e.message}}},async resetPassword(e){try{let{error:t}=await l.N.auth.resetPasswordForEmail(e,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(t)throw t;return{success:!0}}catch(e){return{success:!1,error:e.message}}},async updatePassword(e){try{let{error:t}=await l.N.auth.updateUser({password:e});if(t)throw t;return{success:!0}}catch(e){return{success:!1,error:e.message}}},async updateProfile(e){let{name:t,student_id:s,department:r,year:a}=e;try{let{data:e,error:n}=await l.N.auth.updateUser({data:{name:t,student_id:s,department:r,year:a}});if(n)throw n;let i=e.user.id,{error:c}=await l.N.from("profiles").update({username:t,student_id:s,department:r,year:a}).eq("id",i);if(c)throw c;return{success:!0,user:e.user}}catch(e){return console.error("更新個人資料失敗:",e),{success:!1,error:e.message}}},async verifyOtp(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"email";try{let{data:r,error:a}=await l.N.auth.verifyOtp({email:e,token:t,type:s});if(a)throw a;return{success:!0,data:r}}catch(e){return{success:!1,error:e.message}}},async resendOtp(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"signup";try{let{error:s}=await l.N.auth.resend({type:t,email:e});if(s)throw s;return{success:!0}}catch(e){return{success:!1,error:e.message}}},onAuthStateChange:e=>l.N.auth.onAuthStateChange((t,s)=>{e(t,s)})},i=(0,a.createContext)({}),c=()=>{let e=(0,a.useContext)(i);if(!e)throw Error("useAuth must be used within an AuthProvider");return e},u=e=>{let{children:t}=e,[s,c]=(0,a.useState)(null),[u,o]=(0,a.useState)(!0),[d,m]=(0,a.useState)(null);(0,a.useEffect)(()=>{let e=async()=>{let e=await n.getCurrentUser();e.success&&e.user&&c(e.user),o(!1)};e();let{data:{subscription:t}}=n.onAuthStateChange(async(t,s)=>{if("SIGNED_IN"===t&&(null==s?void 0:s.user)){var r;let t=s.user,{data:a}=await l.N.from("profiles").select("id").eq("id",t.id).single();!a&&(null==(r=t.raw_user_meta_data)?void 0:r.name)&&(await l.N.from("profiles").insert({id:t.id,username:t.raw_user_meta_data.name,student_id:t.raw_user_meta_data.student_id,role:"user"}),await l.N.auth.updateUser({data:{display_name:t.raw_user_meta_data.name}})),await e(),m(null)}else"SIGNED_OUT"===t&&(c(null),m(null));o(!1)});return()=>{null==t||t.unsubscribe()}},[]);let h={user:s,loading:u,error:d,signUp:async function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};m(null);let r=await n.signUp(e,t,s);return r.success||m(r.error),r},signIn:async(e,t)=>{m(null);let s=await n.signIn(e,t);return s.success||m(s.error),s},signOut:async()=>{m(null);let e=await n.signOut();return e.success?c(null):m(e.error),e},resetPassword:async e=>{m(null);let t=await n.resetPassword(e);return t.success||m(t.error),t},updatePassword:async e=>{m(null);let t=await n.updatePassword(e);return t.success||m(t.error),t},updateProfile:async e=>{m(null);let{name:t,student_id:s}=e,r=await n.updateProfile({name:t,student_id:s});if(r.success){let e=await n.getCurrentUser();e.success&&c(e.user)}else m(r.error);return r},verifyOtp:async function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"email";m(null);let r=await n.verifyOtp(e,t,s);return r.success||m(r.error),r},resendOtp:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"signup";m(null);let s=await n.resendOtp(e,t);return s.success||m(s.error),s},isAuthenticated:!!s,isAdmin:(null==s?void 0:s.role)==="admin"};return(0,r.jsx)(i.Provider,{value:h,children:t})}},51154:(e,t,s)=>{"use strict";s.d(t,{A:()=>r});let r=(0,s(19946).A)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},88479:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>h});var r=s(95155),a=s(12115),l=s(35695);s(6874);var n=s(25215),i=s(40646),c=s(90232),u=s(1243),o=s(51154);let d=e=>{let{value:t,onChange:s,disabled:l}=e,n=(0,a.useRef)([]);return(0,r.jsx)("div",{className:"flex justify-center gap-2 sm:gap-3",children:Array(6).fill("").map((e,a)=>(0,r.jsx)("input",{ref:e=>n.current[a]=e,type:"text",inputMode:"numeric",maxLength:"1",value:t[a]||"",onChange:e=>((e,r)=>{let a=e.target.value;if(!/^[0-9]$/.test(a)&&""!==a)return;let l=[...t];if(l[r]=a,s(l.join("")),""!==a&&r<5){var i;null==(i=n.current[r+1])||i.focus()}})(e,a),onKeyDown:e=>((e,s)=>{if("Backspace"===e.key&&""===t[s]&&s>0){var r;null==(r=n.current[s-1])||r.focus()}})(e,a),disabled:l,className:"w-12 h-14 sm:w-14 sm:h-16 text-center text-2xl sm:text-3xl font-bold bg-slate-100 border-2 border-slate-200 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all duration-200 disabled:opacity-50"},a))})};function m(){let e=(0,l.useRouter)(),t=(0,l.useSearchParams)(),{verifyOtp:s,resendOtp:m,loading:h}=(0,n.A)(),[g,f]=(0,a.useState)("waiting"),[p,x]=(0,a.useState)(""),[w,y]=(0,a.useState)(""),[b,N]=(0,a.useState)(""),[j,v]=(0,a.useState)(""),[A,_]=(0,a.useState)(!1),[S,k]=(0,a.useState)(0),[C,I]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let e=t.get("email");e&&x(decodeURIComponent(e))},[t]),(0,a.useEffect)(()=>{if(S>0){let e=setTimeout(()=>k(S-1),1e3);return()=>clearTimeout(e)}},[S]);let U=async t=>{if(t.preventDefault(),6!==j.length||A)return;_(!0),N(""),y("");let r=await s(p,j,"signup");r.success?(f("success"),setTimeout(()=>e.push("/profile"),3e3)):(N(r.error||"無效的驗證碼或驗證碼已過期，請重試。"),v("")),_(!1)},P=async()=>{if(S>0||!p)return;I(!0),N("");let e=await m(p,"signup");e.success?(y("新的驗證郵件已成功發送！"),k(60)):N(e.error||"重新發送失敗，請稍後再試。"),I(!1)},O=(e,t)=>(0,r.jsx)("div",{className:"w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center mx-auto mb-5 bg-opacity-10 ".concat(t.bg),children:(0,r.jsx)(e,{className:"w-8 h-8 sm:w-10 sm:h-10 ".concat(t.text)})});return"success"===g?(0,r.jsxs)("div",{className:"text-center",children:[O(i.A,{bg:"bg-emerald-500",text:"text-emerald-500"}),(0,r.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold text-slate-800 mb-2",children:"驗證成功！"}),(0,r.jsx)("p",{className:"text-slate-500 mb-6",children:"您的帳號已成功啟用。將在 3 秒後自動跳轉至您的個人頁面。"}),(0,r.jsx)("button",{onClick:()=>e.push("/profile"),className:"w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors",children:"立即前往"})]}):(0,r.jsxs)("div",{className:"w-full",children:[O(c.A,{bg:"bg-indigo-500",text:"text-indigo-600"}),(0,r.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold text-slate-800 text-center mb-2",children:"確認您的電子信箱"}),(0,r.jsxs)("p",{className:"text-slate-500 text-center mb-8",children:["我們已發送一封帶有 6 位數驗證碼的郵件至 ",(0,r.jsx)("strong",{className:"text-slate-700",children:p||"您的信箱"}),"。",(0,r.jsx)("br",{}),"請輸入驗證碼以完成註冊。"]}),(0,r.jsxs)("form",{onSubmit:U,className:"space-y-6",children:[(0,r.jsx)(d,{value:j,onChange:v,disabled:A}),b&&(0,r.jsxs)("div",{className:"flex items-start gap-2 text-red-600 bg-red-50 p-3 rounded-lg",children:[(0,r.jsx)(u.A,{className:"w-5 h-5 mt-0.5 flex-shrink-0"}),(0,r.jsx)("p",{className:"text-sm font-medium",children:b})]}),w&&!b&&(0,r.jsxs)("div",{className:"flex items-start gap-2 text-emerald-600 bg-emerald-50 p-3 rounded-lg",children:[(0,r.jsx)(i.A,{className:"w-5 h-5 mt-0.5 flex-shrink-0"}),(0,r.jsx)("p",{className:"text-sm font-medium",children:w})]}),(0,r.jsx)("button",{type:"submit",disabled:6!==j.length||A||h,className:"w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-400 disabled:cursor-not-allowed flex justify-center items-center transition-colors",children:A?(0,r.jsx)(o.A,{className:"w-6 h-6 animate-spin"}):"驗證並登入"})]}),(0,r.jsxs)("div",{className:"text-center mt-8",children:[(0,r.jsx)("p",{className:"text-slate-500",children:"沒有收到郵件嗎？"}),(0,r.jsx)("button",{onClick:P,disabled:S>0||C||h,className:"font-semibold text-indigo-600 hover:text-indigo-800 disabled:text-slate-400 disabled:cursor-not-allowed transition-colors",children:C?(0,r.jsxs)("span",{className:"flex items-center gap-2",children:[(0,r.jsx)(o.A,{className:"w-4 h-4 animate-spin"})," 發送中..."]}):S>0?"在 ".concat(S," 秒後重新發送"):"重新發送驗證碼"})]})]})}function h(){return(0,r.jsx)(a.Suspense,{fallback:(0,r.jsxs)("div",{className:"w-full max-w-md mx-auto p-8 sm:p-10 bg-white rounded-xl shadow-lg text-center",children:[(0,r.jsx)(o.A,{className:"w-12 h-12 text-indigo-500 animate-spin mx-auto"}),(0,r.jsx)("p",{className:"text-slate-500 mt-4",children:"正在載入頁面..."})]}),children:(0,r.jsx)("div",{className:"bg-slate-50 flex items-center justify-center p-4",children:(0,r.jsx)("div",{className:"w-full max-w-md mx-auto p-8 sm:p-10 bg-white rounded-xl shadow-lg",children:(0,r.jsx)(m,{})})})})}},90232:(e,t,s)=>{"use strict";s.d(t,{A:()=>r});let r=(0,s(19946).A)("shield-check",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]])}},e=>{e.O(0,[1658,6874,8441,5964,7358],()=>e(e.s=33962)),_N_E=e.O()}]);